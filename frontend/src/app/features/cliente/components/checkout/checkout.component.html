<div class="checkout-container">
  <div class="checkout-header">
    <h1>üõí Finalizar Compra</h1>
    <button class="back-btn" (click)="goBack()">
      ‚Üê Volver al carrito
    </button>
  </div>

  <div class="checkout-content">
    <!-- Stepper -->
    <div class="checkout-stepper">
      <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
        <div class="step-number">1</div>
        <div class="step-label">Datos de Env√≠o</div>
      </div>
      <div class="step-line" [class.completed]="currentStep > 1"></div>
      <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
        <div class="step-number">2</div>
        <div class="step-label">M√©todo de Pago</div>
      </div>
      <div class="step-line" [class.completed]="currentStep > 2"></div>
      <div class="step" [class.active]="currentStep === 3">
        <div class="step-number">3</div>
        <div class="step-label">Confirmar Pedido</div>
      </div>
    </div>

    <div class="checkout-main">
      <!-- Formulario -->
      <div class="checkout-form-section">
        <form [formGroup]="checkoutForm">
          <!-- Paso 1: Datos de Env√≠o -->
          <div class="form-step" *ngIf="currentStep === 1">
            <h2>Datos de Env√≠o</h2>

            <div class="form-grid">
              <div class="form-field full-width">
                <label>Direcci√≥n de Env√≠o *</label>
                <textarea
                  formControlName="direccion_envio"
                  rows="3"
                  placeholder="Ingresa tu direcci√≥n completa"
                  class="form-textarea"></textarea>
                <small class="error" *ngIf="checkoutForm.get('direccion_envio')?.invalid && checkoutForm.get('direccion_envio')?.touched">
                  La direcci√≥n es requerida (m√≠nimo 10 caracteres)
                </small>
              </div>

              <div class="form-field">
                <label>Ciudad *</label>
                <input type="text"
                       formControlName="ciudad_envio"
                       placeholder="Ciudad"
                       class="form-input">
                <small class="error" *ngIf="checkoutForm.get('ciudad_envio')?.invalid && checkoutForm.get('ciudad_envio')?.touched">
                  La ciudad es requerida
                </small>
              </div>

              <div class="form-field">
                <label>Pa√≠s *</label>
                <select formControlName="pais_envio" class="form-select">
                  <option *ngFor="let country of countries" [value]="country.value">{{ country.label }}</option>
                </select>
              </div>

              <div class="form-field">
                <label>C√≥digo Postal</label>
                <input type="text"
                       formControlName="codigo_postal"
                       placeholder="C√≥digo postal (opcional)"
                       class="form-input">
              </div>

              <div class="form-field">
                <label>Tel√©fono de Contacto *</label>
                <input type="tel"
                       formControlName="telefono_contacto"
                       placeholder="+502 1234-5678"
                       class="form-input">
                <small class="error" *ngIf="checkoutForm.get('telefono_contacto')?.invalid && checkoutForm.get('telefono_contacto')?.touched">
                  Ingresa un tel√©fono v√°lido
                </small>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="next-btn" (click)="nextStep()">
                Siguiente ‚Üí
              </button>
            </div>
          </div>

          <!-- Paso 2: M√©todo de Pago -->
          <div class="form-step" *ngIf="currentStep === 2">
            <h2>M√©todo de Pago</h2>

            <div class="payment-methods-grid">
              <div class="payment-method" *ngFor="let method of paymentMethods"
                   [class.selected]="checkoutForm.value.tipo_pago === method.value"
                   (click)="checkoutForm.patchValue({tipo_pago: method.value})">
                <span class="payment-icon">{{ method.icon }}</span>
                <span>{{ method.label }}</span>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="prev-btn" (click)="prevStep()">
                ‚Üê Anterior
              </button>
              <button type="button" class="next-btn" (click)="nextStep()">
                Siguiente ‚Üí
              </button>
            </div>
          </div>

          <!-- Paso 3: Confirmar Pedido -->
          <div class="form-step" *ngIf="currentStep === 3">
            <h2>Confirmar Pedido</h2>

            <!-- Resumen de env√≠o -->
            <div class="summary-box">
              <h3>üìç Datos de Env√≠o</h3>
              <p><strong>Direcci√≥n:</strong> {{ checkoutForm.value.direccion_envio }}</p>
              <p><strong>Ciudad:</strong> {{ checkoutForm.value.ciudad_envio }}</p>
              <p><strong>Pa√≠s:</strong> {{ checkoutForm.value.pais_envio }}</p>
              <p><strong>Tel√©fono:</strong> {{ checkoutForm.value.telefono_contacto }}</p>
            </div>

            <!-- Resumen de pago -->
            <div class="summary-box">
              <h3>üí≥ M√©todo de Pago</h3>
              <p>{{ paymentMethods.find(m => m.value === checkoutForm.value.tipo_pago)?.label }}</p>
            </div>

            <!-- Productos -->
            <div class="summary-box">
              <h3>üõí Productos ({{ cartItems.length }})</h3>
              <div class="product-summary-list">
                <div class="product-summary-item" *ngFor="let item of cartItems">
                  <img [src]="item.imagen_url || 'assets/no-image.png'" [alt]="item.nombre">
                  <div class="product-summary-info">
                    <p class="product-name">{{ item.nombre }}</p>
                    <p class="product-quantity">Cantidad: {{ item.cantidad }}</p>
                  </div>
                  <p class="product-price">Q{{ item.subtotal | number:'1.2-2' }}</p>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="prev-btn" (click)="prevStep()">
                ‚Üê Anterior
              </button>
              <button type="button" class="confirm-btn" (click)="confirmOrder()" [disabled]="loading">
                {{ loading ? '‚è≥ Procesando...' : '‚úì Confirmar Pedido' }}
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Resumen del pedido (sidebar) -->
      <div class="order-summary-sidebar">
        <h2>Resumen del Pedido</h2>

        <div class="summary-details">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>Q{{ subtotal | number:'1.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span>IVA (13%):</span>
            <span>Q{{ iva | number:'1.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span>Env√≠o:</span>
            <span>Q{{ shippingCost | number:'1.2-2' }}</span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row summary-total">
            <span>Total:</span>
            <span class="total-value">Q{{ total | number:'1.2-2' }}</span>
          </div>
        </div>

        <div class="security-info">
          üîí Transacci√≥n segura y protegida
        </div>
      </div>
    </div>
  </div>
</div>
