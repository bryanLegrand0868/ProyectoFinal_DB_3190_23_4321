<p-toast></p-toast>

<div class="dashboard-container" *ngIf="!loading; else loadingTemplate">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">
      <i class="pi pi-chart-line"></i>
      Dashboard Administrativo
    </h1>
    <p class="dashboard-subtitle">Resumen general del sistema</p>
  </div>

  <!-- Stats Cards -->
  <div class="p-grid stats-grid">
    <!-- Total Ventas -->
    <div class="p-col-12 p-md-6 p-lg-3">
      <div class="stat-card stat-card-sales">
        <div class="stat-card-icon">
          <i class="pi pi-shopping-cart"></i>
        </div>
        <div class="stat-card-content">
          <div class="stat-card-label">Ventas Totales</div>
          <div class="stat-card-value">{{ stats.totalSales | currency:'Q':'symbol':'1.2-2' }}</div>
          <div class="stat-card-growth" [ngClass]="{'positive': stats.salesGrowth >= 0, 'negative': stats.salesGrowth < 0}">
            <i [class]="stats.salesGrowth >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
            {{ stats.salesGrowth | number:'1.0-1' }}% vs mes anterior
          </div>
        </div>
      </div>
    </div>

    <!-- Productos -->
    <div class="p-col-12 p-md-6 p-lg-3">
      <div class="stat-card stat-card-products">
        <div class="stat-card-icon">
          <i class="pi pi-box"></i>
        </div>
        <div class="stat-card-content">
          <div class="stat-card-label">Productos</div>
          <div class="stat-card-value">{{ stats.totalProducts | number }}</div>
          <div class="stat-card-desc" [ngClass]="{'warning': stats.lowStockItems > 0}">
            <i class="pi pi-exclamation-triangle" *ngIf="stats.lowStockItems > 0"></i>
            {{ stats.lowStockItems }} con bajo stock
          </div>
        </div>
      </div>
    </div>

    <!-- Clientes -->
    <div class="p-col-12 p-md-6 p-lg-3">
      <div class="stat-card stat-card-customers">
        <div class="stat-card-icon">
          <i class="pi pi-users"></i>
        </div>
        <div class="stat-card-content">
          <div class="stat-card-label">Clientes</div>
          <div class="stat-card-value">{{ stats.totalCustomers | number }}</div>
          <div class="stat-card-desc positive">
            <i class="pi pi-plus"></i>
            {{ stats.newCustomers | number }} nuevos este mes
          </div>
        </div>
      </div>
    </div>

    <!-- Pedidos -->
    <div class="p-col-12 p-md-6 p-lg-3">
      <div class="stat-card stat-card-orders">
        <div class="stat-card-icon">
          <i class="pi pi-shopping-bag"></i>
        </div>
        <div class="stat-card-content">
          <div class="stat-card-label">Pedidos Pendientes</div>
          <div class="stat-card-value">{{ stats.pendingOrders | number }}</div>
          <div class="stat-card-desc">
            {{ stats.completedOrders | number }} completados
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Quick Actions -->
  <div class="p-grid">
    <!-- Sales Chart -->
    <div class="p-col-12 p-lg-8">
      <p-card header="Ventas Mensuales" styleClass="chart-card">
        <p-chart type="line" [data]="salesData" [options]="chartOptions" height="350"></p-chart>
      </p-card>
    </div>

    <!-- Quick Actions -->
    <div class="p-col-12 p-lg-4">
      <p-card header="Acciones RÃ¡pidas" styleClass="actions-card">
        <div class="quick-actions">
          <button pButton 
                  type="button" 
                  label="Ver Productos" 
                  icon="pi pi-box" 
                  class="p-button-outlined w-full mb-2"
                  (click)="loadProducts()">
          </button>
          <button pButton 
                  type="button" 
                  label="Ver Clientes" 
                  icon="pi pi-users" 
                  class="p-button-outlined p-button-info w-full mb-2"
                  (click)="loadClients()">
          </button>
          <button pButton 
                  type="button" 
                  label="Ver Pedidos" 
                  icon="pi pi-shopping-bag" 
                  class="p-button-outlined p-button-warning w-full mb-2"
                  (click)="showOrders()">
          </button>
          <button pButton 
                  type="button" 
                  label="Ver Ventas" 
                  icon="pi pi-chart-line" 
                  class="p-button-outlined p-button-help w-full"
                  (click)="loadSales()">
          </button>
        </div>
      </p-card>
    </div>
  </div>
</div>

<!-- Modal de Datos -->
<p-dialog 
  [(visible)]="displayModal" 
  [modal]="true" 
  [style]="{ width: '90vw', maxWidth: '1200px' }"
  [draggable]="false" 
  [resizable]="false"
  [contentStyle]="{ 'max-height': '70vh', 'overflow': 'auto' }"
  [baseZIndex]="10000"
  styleClass="data-modal">
  
  <p-header>
    <div class="modal-header-content">
      <i class="pi pi-table mr-2"></i>
      <span class="font-bold text-xl">{{modalTitle}}</span>
    </div>
  </p-header>

  <div *ngIf="loadingModal" class="loading-overlay">
    <p-progressSpinner 
      strokeWidth="4" 
      animationDuration=".5s"
      [style]="{width: '50px', height: '50px'}">
    </p-progressSpinner>
  </div>

  <p-table 
    *ngIf="!loadingModal" 
    [value]="modalData" 
    [scrollable]="true" 
    scrollHeight="400px"
    [rows]="10"
    [paginator]="true" 
    [rowsPerPageOptions]="[5,10,25,50]"
    [globalFilterFields]="getFilterFields()"
    styleClass="p-datatable-sm p-datatable-striped">
    
    <ng-template pTemplate="header">
      <tr>
        <th *ngFor="let col of modalColumns" 
            [pSortableColumn]="col.field"
            [style.width]="col.width || 'auto'">
          {{col.header}}
          <p-sortIcon [field]="col.field"></p-sortIcon>
        </th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-rowData>
      <tr>
        <td *ngFor="let col of modalColumns">
          <ng-container [ngSwitch]="col.type">
            <ng-container *ngSwitchCase="'currency'">
              {{formatCellValue(rowData, col.field, 'currency')}}
            </ng-container>
            <ng-container *ngSwitchCase="'date'">
              {{formatCellValue(rowData, col.field, 'date')}}
            </ng-container>
            <ng-container *ngSwitchCase="'status'">
              <span 
                class="status-badge" 
                [ngClass]="getStatusClass(getNestedValue(rowData, col.field))">
                {{formatCellValue(rowData, col.field, 'status')}}
              </span>
            </ng-container>
            <ng-container *ngSwitchDefault>
              {{getNestedValue(rowData, col.field)}}
            </ng-container>
          </ng-container>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="modalColumns.length" class="text-center p-4">
          <div class="empty-state">
            <i class="pi pi-inbox" style="font-size: 3rem; color: #9ca3af;"></i>
            <p class="mt-2 text-gray-500">No se encontraron registros</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
  
  <ng-template pTemplate="footer">
    <div class="modal-footer-content">
      <button 
        pButton 
        type="button" 
        label="Cerrar" 
        icon="pi pi-times" 
        class="p-button-text"
        (click)="displayModal = false">
      </button>
      <button 
        pButton 
        type="button" 
        label="Exportar a Excel" 
        icon="pi pi-file-excel" 
        class="p-button-success"
        (click)="exportToExcel()">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Hidden table for Excel export -->
<table id="exportTable" style="display: none;">
  <thead>
    <tr>
      <th *ngFor="let col of modalColumns">{{col.header}}</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let item of modalData">
      <td *ngFor="let col of modalColumns">
        {{formatCellValue(item, col.field, col.type)}}
      </td>
    </tr>
  </tbody>
</table>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="loading-container">
    <p-progressSpinner 
      strokeWidth="4"
      [style]="{width: '70px', height: '70px'}">
    </p-progressSpinner>
    <p class="loading-text">Cargando datos del dashboard...</p>
  </div>
</ng-template>