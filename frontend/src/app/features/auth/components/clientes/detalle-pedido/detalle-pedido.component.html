<div class="detalle-pedido-container">
  <!-- Header -->
  <div class="detalle-header">
    <button type="button"
            class="btn-text btn-lg"
            (click)="goBack()">
      ⬅️ Volver
    </button>
    <h1>
      <span class="header-icon">📦</span>
      Detalle del Pedido #{{ orderId }}
    </h1>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner">⏳ Cargando detalle del pedido...</div>
  </div>

  <!-- Contenido del pedido -->
  <div class="pedido-content" *ngIf="!loading && order">
    <!-- Información general del pedido -->
    <div class="pedido-info-card">
      <div class="info-header">
        <h2>Información del Pedido</h2>
        <div class="status-badges">
          <span class="status-badge" [ngClass]="getEstadoClass(order.estado_pedido)">
            {{ formatEstado(order.estado_pedido) }}
          </span>
          <span class="payment-badge">
            Pago: {{ formatEstadoPago(order.estado_pago) }}
          </span>
        </div>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label><span class="info-icon">📅</span> Fecha del Pedido</label>
          <p>{{ order.fecha_pedido | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>

        <div class="info-item">
          <label><span class="info-icon">💳</span> Método de Pago</label>
          <p>{{ order.tipo_pago?.replace('_', ' ') }}</p>
        </div>

        <div class="info-item">
          <label><span class="info-icon">📍</span> Dirección de Envío</label>
          <p>{{ order.direccion_envio }}</p>
          <p class="secondary">{{ order.ciudad_envio }}, {{ order.pais_envio }}</p>
        </div>

        <div class="info-item">
          <label><span class="info-icon">📞</span> Teléfono de Contacto</label>
          <p>{{ order.telefono_contacto }}</p>
        </div>

        <div class="info-item" *ngIf="order.fecha_entrega_estimada">
          <label><span class="info-icon">🚚</span> Entrega Estimada</label>
          <p>{{ order.fecha_entrega_estimada | date:'dd/MM/yyyy' }}</p>
        </div>

        <div class="info-item" *ngIf="order.fecha_entrega_real">
          <label><span class="info-icon">✅</span> Entrega Real</label>
          <p>{{ order.fecha_entrega_real | date:'dd/MM/yyyy' }}</p>
        </div>
      </div>
    </div>

    <div class="pedido-grid">
      <!-- Productos del pedido -->
      <div class="productos-card">
        <h2>
          <span class="header-icon">🛒</span>
          Productos ({{ orderDetails.length }})
        </h2>

        <div class="productos-list">
          <div class="producto-item" *ngFor="let detail of orderDetails">
            <div class="producto-image">
              <img [src]="detail.imagen_url || 'assets/no-image.png'"
                   [alt]="detail.nombre_producto">
            </div>

            <div class="producto-details">
              <h3>{{ detail.nombre_producto }}</h3>
              <p class="producto-meta">{{ detail.categoria }} - {{ detail.marca }}</p>
              <div class="producto-pricing">
                <span class="precio-unitario">Q{{ detail.precio_unitario | number:'1.2-2' }} × {{ detail.cantidad }}</span>
                <span class="descuento" *ngIf="detail.descuento > 0">
                  -Q{{ detail.descuento | number:'1.2-2' }}
                </span>
              </div>
            </div>

            <div class="producto-subtotal">
              <label>Subtotal</label>
              <p>Q{{ getProductSubtotal(detail) | number:'1.2-2' }}</p>
            </div>
          </div>
        </div>

        <!-- Resumen de totales -->
        <div class="totales-section">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>Q{{ order.subtotal | number:'1.2-2' }}</span>
          </div>
          <div class="total-row">
            <span>IVA (13%):</span>
            <span>Q{{ order.iva | number:'1.2-2' }}</span>
          </div>
          <div class="total-row">
            <span>Costo de Envío:</span>
            <span>Q{{ order.costo_envio | number:'1.2-2' }}</span>
          </div>
          <div class="total-divider"></div>
          <div class="total-row total-final">
            <span>Total:</span>
            <span class="total-value">Q{{ order.total | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>

      <!-- Tracking del pedido -->
      <div class="tracking-card">
        <h2>
          <span class="header-icon">🗺️</span>
          Seguimiento del Pedido
        </h2>

        <!-- Timeline -->
        <div class="tracking-timeline" *ngIf="trackingHistory.length > 0">
          <div class="timeline-item" *ngFor="let track of trackingHistory; let isFirst = first"
               [class.first-item]="isFirst">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <div class="timeline-header">
                <h4>{{ track.estado }}</h4>
                <span class="timeline-date">{{ track.fecha_hora | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <p class="timeline-description">{{ track.descripcion }}</p>
              <p class="timeline-location" *ngIf="track.ubicacion">
                <span class="location-icon">📍</span>
                {{ track.ubicacion }}
              </p>
            </div>
          </div>
        </div>

        <!-- Sin tracking -->
        <div class="no-tracking" *ngIf="trackingHistory.length === 0">
          <div class="no-tracking-icon">ℹ️</div>
          <p>Aún no hay información de seguimiento disponible</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Sin datos -->
  <div class="empty-state" *ngIf="!loading && !order">
    <div class="empty-icon">⚠️</div>
    <h2>Pedido no encontrado</h2>
    <p>No se pudo cargar la información del pedido</p>
    <button type="button"
            class="btn-lg btn-primary"
            (click)="goBack()">
      ⬅️ Volver a mis pedidos
    </button>
  </div>
</div>